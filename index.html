<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finan칞as Mensais</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f1a2e;
      --card2: #111f36;
      --muted: #95a3b8;
      --text: #e8eefc;
      --line: rgba(255,255,255,.08);
      --good: #31d0aa;
      --bad: #ff5c7a;
      --warn: #ffd166;
      --accent: #6ea8ff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      background: radial-gradient(900px 450px at 20% 0%, rgba(110,168,255,.22), transparent 60%), 
                  radial-gradient(700px 450px at 90% 10%, rgba(49,208,170,.18), transparent 55%), 
                  radial-gradient(900px 550px at 50% 120%, rgba(255,92,122,.10), transparent 60%), var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: inherit; }
    .app {
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    .topbar {
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: rgba(11,18,32,.72);
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: 14px 14px;
      box-shadow: var(--shadow);
    }
    .toprow {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 240px;
    }
    .logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(110,168,255,.95), rgba(49,208,170,.8));
      box-shadow: 0 10px 25px rgba(110,168,255,.18);
    }
    .brand h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .brand p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 8px 10px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .pill label {
      font-size: 12px;
      color: var(--muted);
    }
    select, input, button {
      font: inherit;
      color: var(--text);
    }
    select, input {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      outline: none;
      padding: 10px 12px;
      border-radius: 12px;
      transition: .15s ease;
    }
    select:focus, input:focus {
      border-color: rgba(110,168,255,.55);
      box-shadow: 0 0 0 4px rgba(110,168,255,.12);
    }
    .btn {
      background: rgba(110,168,255,.20);
      border: 1px solid rgba(110,168,255,.35);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      transition: .15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .btn:hover {
      transform: translateY(-1px);
      background: rgba(110,168,255,.28);
    }
    .btn:active {
      transform: translateY(0px);
    }
    .btn.secondary {
      background: rgba(110,168,255,.28);
      border: 10px solid var(--line);
    }
    .grid {
      display: grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      .brand { min-width: unset; }
    }
    .card {
      background: linear-gradient(180deg, rgba(15,26,46,.95), rgba(15,26,46,.75));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .cardHeader {
      padding: 14px 14px 10px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .cardHeader h2 {
      margin: 0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .cardHeader .hint {
      font-size: 12px;
      color: var(--muted);
    }
    .cardBody {
      padding: 8px;
    }
    .summary {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
    }
    @media (max-width: 980px) {
      .summary { grid-template-columns: repeat(2, 1fr); }
    }
    .kpi {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 5px;
      min-height: px;
    }
    .kpi .label {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .kpi .value {
      margin-top: 6px;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.04);
    }
    .value.good {
      color: var(--good);
    }
    .value.bad {
      color: var(--bad);
    }
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .tab {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }
    .tab.active {
      color: var(--text);
      border-color: rgba(110,168,255,.45);
      background: rgba(110,168,255,.14);
    }
    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      background: rgba(0,0,0,.55);
      padding: 16px;
      z-index: 50;
    }
    .overlay.show {
      display: flex;
    }
    .modal {
      width: min(680px, 100%);
      border-radius: 22px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,31,54,.98), rgba(15,26,46,.92));
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow: hidden;
      transform: translateY(10px);
      animation: up .18s ease forwards;
    }
    @keyframes up {
      to {
        transform: translateY(0);
      }
    }
    .modalHeader {
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .modalHeader strong {
      font-size: 14px;
    }
    .modalBody {
      padding: 14px;
    }
    .modalFooter {
      padding: 14px;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      background: rgba(255,255,255,.02);
    }
    .mini {
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" style="position:fixed; inset:0; background:#0b1220; display:flex; align-items:center; justify-content:center; z-index:999;">
    <div style="background:#111f36; padding:30px; border-radius:20px; width:320px; display:flex; flex-direction:column; gap:15px;">
      <div>
        <center>
          <h3>Controle de Finan칞as Mensais</h3>
        </center>
      </div>
      <input id="loginEmail" placeholder="Email">
      <input id="loginPass" type="password" placeholder="Senha">
      <button id="btnLogin" class="btn">Entrar</button>
      <button id="btnRegister" class="btn secondary">Cadastrar</button>
    </div>
  </div>
  
  <!-- APP CONTAINER -->
  <div class="app">
    <div class="topbar">
      <div class="toprow">
        <div class="brand">
          <div id="userBox" style="display:flex;align-items:center;gap:10px;">
            <img id="userAvatar" style="width:54px;height:54px;border-radius:50%;object-fit:cover;border:2px solid #6ea8ff;">
            <span id="userName" style="font-size:23px;"></span>
          </div>
        </div>
        <div class="controls">
          <div class="pill">
            <label>M칡s</label>
            <select id="month"></select>
          </div>
          <div class="pill">
            <label>Ano</label>
            <select id="year"></select>
          </div>
          <button class="btn secondary" id="btnPDF">Gerar Relat칩rio</button>
          <button class="btn secondary" onclick="logout()">游뛁 Sair</button>
        </div>
      </div>
    </div>
  
    <!-- Main content and components here -->
    <!-- Add your HTML cards, grids, modals, etc. -->

  </div>

  <script>
    /* ================= UTIL ================= */
    const fmt = n => (Number(n) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    const uid = () => Math.random().toString(36).slice(2, 10);

    let db = null;
    let currentUser = null;

    let state = {
      selected: { month: new Date().getMonth(), year: new Date().getFullYear() },
      data: {}
    };

    function keyMY(m, y) {
      return `${y}-${String(m + 1).padStart(2, "0")}`;
    }

    function ensureBucket(m = state.selected.month, y = state.selected.year) {
      const k = keyMY(m, y);
      if (!state.data[k]) state.data[k] = { incomes: [], expenses: [] };
      return state.data[k];
    }

    /* ================= LOGIN ================= */
    function getUsers() {
      return JSON.parse(localStorage.getItem("usuarios_financas") || "[]");
    }

    function saveUsers(users) {
      localStorage.setItem("usuarios_financas", JSON.stringify(users));
    }

    btnRegister.onclick = () => {
      const email = loginEmail.value.trim();
      const pass = loginPass.value.trim();
      if (!email || !pass) return alert("Preencha tudo.");
      let users = getUsers();
      if (users.find(u => u.email === email)) return alert("Usu치rio j치 existe.");
      users.push({
        email,
        pass,
        avatar: `https://ui-avatars.com/api/?name=${email}&background=6ea8ff&color=fff`
      });
      saveUsers(users);
      alert("Usu치rio criado!");
    };

    btnLogin.onclick = () => {
      const email = loginEmail.value.trim();
      const pass = loginPass.value.trim();
      const user = getUsers().find(u => u.email === email && u.pass === pass);
      if (!user) return alert("Credenciais inv치lidas.");
      currentUser = email;
      localStorage.setItem("usuario_logado", email);
      document.getElementById("loginScreen").style.display = "none";
      initDBForUser();
    };

    function autoLogin() {
      const saved = localStorage.getItem("usuario_logado");
      if (saved) {
        currentUser = saved;
        document.getElementById("loginScreen").style.display = "none";
        initDBForUser();
      }
    }

    function logout() {
      localStorage.removeItem("usuario_logado");
      location.reload();
    }

    /* ================= DATABASE ================= */
    function initDBForUser() {
      const request = indexedDB.open("financasDB_" + currentUser, 1);
      request.onupgradeneeded = e => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("meses")) {
          db.createObjectStore("meses", { keyPath: "id" });
        }
      };
      request.onsuccess = e => {
        db = e.target.result;
        loadDB();
        loadUserInfo();
        startInactivityTimer();
      };
    }

    function saveDB() {
      const tx = db.transaction(["meses"], "readwrite");
      tx.objectStore("meses").put({ id: "dados_financas", data: state.data, selected: state.selected });
    }

    function loadDB() {
      const tx = db.transaction(["meses"], "readonly");
      const request = tx.objectStore("meses").get("dados_financas");
      request.onsuccess = () => {
        if (request.result) {
          state.data = request.result.data || {};
          state.selected = request.result.selected || state.selected;
        }
        initMonthYear();
        render();
      };
    }

    /* ================= DISPLAY USER INFO ================= */
    function loadUserInfo() {
      const users = getUsers();
      const user = users.find(u => u.email === currentUser);
      if (!user) return;
      document.getElementById("userName").textContent = currentUser;
      document.getElementById("userAvatar").src = user.avatar;
    }

    /* ================= INACTIVITY TIMER ================= */
    let inactivityTimer;
    const TIME_LIMIT = 10 * 60 * 1000;

    function resetTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        alert("Sess칚o expirada por inatividade.");
        logout();
      }, TIME_LIMIT);
    }

    function startInactivityTimer() {
      ["click", "mousemove", "keypress", "scroll", "touchstart"]
        .forEach(event => document.addEventListener(event, resetTimer));
      resetTimer();
    }

    /* ================= MONTH SELECTION ================= */
    const monthSel = document.getElementById("month");
    const yearSel = document.getElementById("year");

    function initMonthYear() {
      const months = ["Janeiro", "Fevereiro", "Mar칞o", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      monthSel.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join("");
      const currentYear = new Date().getFullYear();
      yearSel.innerHTML = "";
      for (let i = currentYear - 5; i <= currentYear + 5; i++) {
        yearSel.innerHTML += `<option value="${i}">${i}</option>`;
      }
      monthSel.value = state.selected.month;
      yearSel.value = state.selected.year;
      monthSel.onchange = () => {
        state.selected.month = Number(monthSel.value);
        saveDB();
        render();
      };
      yearSel.onchange = () => {
        state.selected.year = Number(yearSel.value);
        saveDB();
        render();
      };
    }

    /* ================= RECEITAS ================= */
    btnAddIncome.onclick = () => {
      const bucket = ensureBucket();
      const name = incName.value.trim() || "Sal치rio";
      const value = Number(incValue.value);
      if (!value || value <= 0) return alert("Valor inv치lido.");
      bucket.incomes.push({ id: uid(), name, value });
      incName.value = "";
      incValue.value = "";
      saveDB();
      render();
    };

    /* ================= DESPESAS ================= */
    expCat.addEventListener("change", () => {
      expParcelas.style.display = expCat.value === "FIXA" ? "block" : "none";
    });

    btnAddExpense.onclick = () => {
      const name = expName.value.trim() || "Conta";
      const valor = Number(expValue.value);
      const category = expCat.value;
      if (!valor || valor <= 0) return alert("Valor inv치lido.");
      const origemId = uid();
      if (category === "FIXA") {
        const parcelas = Number(expParcelas.value || 0);
        if (parcelas < 1) return alert("Informe n칰mero de parcelas.");
        for (let i = 0; i < parcelas; i++) {
          let mes = state.selected.month + i;
          let ano = state.selected.year;
          while (mes > 11) { mes -= 12; ano++; }
          ensureBucket(mes, ano).expenses.push({
            id: uid(),
            origemId,
            name,
            category,
            value: valor,
            parcelaAtual: i + 1,
            totalParcelas: parcelas,
            paid: false
          });
        }
      } else if (category === "CASA") {
        for (let i = 0; i < 120; i++) {
          let mes = state.selected.month + i;
          let ano = state.selected.year;
          while (mes > 11) { mes -= 12; ano++; }
          ensureBucket(mes, ano).expenses.push({
            id: uid(),
            origemId,
            name,
            category,
            value: valor,
            recorrente: true,
            paid: false
          });
        }
      } else {
        ensureBucket().expenses.push({ id: uid(), name, category, value: valor, paid: false });
      }
      expName.value = "";
      expValue.value = "";
      expParcelas.value = "";
      saveDB();
      render();
    };

    /* ================= RENDER ================= */
    function render() {
      renderReceitas();
      renderDespesas();
      renderKPIs();
    }

    function renderReceitas() {
      const bucket = ensureBucket();
      listReceitas.innerHTML = "";
      emptyReceitas.style.display = bucket.incomes.length === 0 ? "block" : "none";
      bucket.incomes.forEach(r => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="title"><strong>${r.name}</strong></div>
          <div class="money">${fmt(r.value)}</div>
          <div class="actions">
            <button class="btn" onclick="removeIncome('${r.id}')">Excluir</button>
          </div>`;
        listReceitas.appendChild(div);
      });
    }

    function renderDespesas() {
      const bucket = ensureBucket();
      listContas.innerHTML = "";
      emptyContas.style.display = bucket.expenses.length === 0 ? "block" : "none";
      bucket.expenses.forEach(c => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="title">
            <strong>${c.name}</strong>
            <div class="meta">
              <span class="chip ${c.paid ? 'good' : 'warn'}">${c.paid ? 'Pago' : 'Pendente'}</span>
              ${c.totalParcelas ? `<span class="chip bad">${c.parcelaAtual}/${c.totalParcelas}</span>` : ""}
              ${c.recorrente ? `<span class="chip good">Recorrente</span>` : ""}
            </div>
          </div>
          <div class="money">${fmt(c.value)}</div>
          <div class="actions">
            <button class="btn" onclick="togglePaid('${c.id}')">${c.paid ? 'Marcar pendente' : 'Marcar pago'}</button>
            ${c.origemId ? `<button class="btn secondary" onclick="removeParcelamento('${c.origemId}')">Excluir Parcelamento</button>` : ""}
            <button class="btn" onclick="removeExpense('${c.id}')">Excluir</button>
          </div>`;
        listContas.appendChild(div);
      });
    }

    function renderKPIs() {
      const bucket = ensureBucket();
      const totalInc = bucket.incomes.reduce((a, b) => a + b.value, 0);
      const totalExp = bucket.expenses.reduce((a, b) => a + b.value, 0);
      const paid = bucket.expenses.filter(x => x.paid).reduce((a, b) => a + b.value, 0);
      kpiReceitas.textContent = fmt(totalInc);
      kpiDespesas.textContent = fmt(totalExp);
      kpiPago.textContent = fmt(paid);
      kpiFalta.textContent = fmt(totalExp - paid);
      kpiSaldo.textContent = fmt(totalInc - totalExp);
    }

    /* ================= PDF ================= */
    btnPDF.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.text("Finan칞as Mensais", 10, y);
      y += 10;
      const bucket = ensureBucket();
      bucket.incomes.forEach(r => {
        doc.text(`Receita: ${r.name} - ${fmt(r.value)}`, 10, y);
        y += 8;
      });
      bucket.expenses.forEach(c => {
        doc.text(`Despesa: ${c.name} - ${fmt(c.value)} - ${c.paid ? "Pago" : "Pendente"}`, 10, y);
        y += 8;
      });
      doc.save("financas.pdf");
    };

    /* ================= START ================= */
    autoLogin();
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr_6mww70fRdSRXVgApPSgDMs1myRLRSg",
      authDomain: "financasmensaispaulods.firebaseapp.com",
      projectId: "financasmensaispaulods",
      storageBucket: "financasmensaispaulods.firebasestorage.app",
      messagingSenderId: "168499253940",
      appId: "1:168499253940:web:8d14795ad8195858283de1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    // Other code for Firebase authentication and Firestore database management.
  </script>
</body>
</html>
